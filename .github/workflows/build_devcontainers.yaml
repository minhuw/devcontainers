name: "Release Dev Container"
on:
    workflow_dispatch:
    push:
        branches:
          - 'master'
        paths:
          - containers/**
          - .github/workflows/build_devcontainers.yaml

env:
    REGISTRY: ghcr.io

jobs:
    detect-changes:
        runs-on: ubuntu-latest
        outputs:
            matrix: ${{ steps.changes.outputs.matrix }}
        steps:
          - name: Checkout repository
            uses: actions/checkout@v3
            with:
                fetch-depth: 0

          - name: Detect changed containers
            id: changes
            run: |
                # Get list of changed files
                if [ "${{ github.event_name }}" = "push" ]; then
                    CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
                else
                    # For workflow_dispatch, build all containers
                    CHANGED_FILES="containers/"
                fi

                # Extract container names from changed paths
                CHANGED_CONTAINERS=$(echo "$CHANGED_FILES" | grep "^containers/" | cut -d'/' -f2 | sort -u)

                # Build matrix JSON
                MATRIX_JSON="["
                FIRST=true
                for container in $CHANGED_CONTAINERS; do
                    if [ -d "containers/$container/.devcontainer" ]; then
                        if [ "$FIRST" = "true" ]; then
                            FIRST=false
                        else
                            MATRIX_JSON="$MATRIX_JSON,"
                        fi
                        MATRIX_JSON="$MATRIX_JSON{\"name\":\"$container\"}"
                    fi
                done
                MATRIX_JSON="$MATRIX_JSON]"

                echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT
                echo "Changed containers: $CHANGED_CONTAINERS"
                echo "Matrix: $MATRIX_JSON"

    build-and-push-image:
        needs: detect-changes
        runs-on: ubuntu-latest
        if: needs.detect-changes.outputs.matrix != '[]'
        strategy:
            fail-fast: false
            max-parallel: 1
            matrix:
              include: ${{ fromJson(needs.detect-changes.outputs.matrix) }}

        permissions:
            contents: read
            packages: write
        steps:
          - name: Checkout repository
            uses: actions/checkout@v3

          - name: Log in to the Container registry
            uses: docker/login-action@65b78e6e13532edd9afa3aa52ac7964289d1a9c1
            with:
                registry: ${{ env.REGISTRY }}
                username: ${{ github.actor }}
                password: ${{ secrets.GITHUB_TOKEN }}

          - name: pre-build devcontainer
            uses: devcontainers/ci@v0.3
            with:
              imageName: ghcr.io/${{ github.actor }}/${{ matrix.name }}-dev
              cacheFrom: ghcr.io/${{ github.actor }}/${{ matrix.name }}-dev
              subFolder: containers/${{ matrix.name }}
              push: always